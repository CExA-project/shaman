# SHAMAN : A library that bridges the gap between humans and the invisible world of numerical errors

Shaman is a C++11 library that use operator overloading and a novel method to evaluate the numerical accuracy of an application.

Shaman has been designed to target high-performance simulations and, thus, we insured that it is not only accurate but also:
- fast enough to be tested on very large simulations[^1]
- compatible with all of C++17 mathematical functions
- threadsafe and compatible with both OpenMP and MPI

[^1]: As numerical error is more likely to appears when large number of operations are in play.

## Usage

Shaman is meant to be used with a test suite (usual recommendations such as having a good coverage apply), for all tests :

- Instrument the code with Shaman (see the `doc/how_to_instrument.md` file).
- Stabilize meaninful branches (unstable branches can be detected with the numerical debugger, see the `doc/how_to_debug.md` file).
- Get the number of significant digits over a specified threshold (by default Shaman will only output digits it considers significant).

Once your branches are stable and your error is low enough, your code is verified.

```cpp
x + y
x.number
x.error
x.digits()
```

## Try it online

Click below to try Shaman online:

[![try it online](https://raw.githubusercontent.com/nestordemeure/Shaman/master/tryItOnline.png)](https://repl.it/@nestordemeure/ShamanDemo?lite=true)

See our `examples` folder for further illustrations of typical use cases.

## Installation

### Compiling Shaman

To compile Shaman, open a shell and run :

```
cmake -DCMAKE_INSTALL_PREFIX=PREFIX .
make install
```

Where `PREFIX` is the path to your desired instalation folder.

### Linking Shaman with Cmake

To add Shaman to a project that is compiled with cmake, add `find_package(shaman)` to the top of your `CMakeLists.txt` file
and `PUBLIC shaman::shaman` to its `target_link_libraries` line.

You might also need to set the `shaman_DIR` variable (with the path to Shaman's autogenerated cmake files) if Shaman's instalation folder is not known to cmake.

## How does Shaman works ?

Shaman overloads operations to run a first order model of the propagation of numerical error in your code.
Having both numbers and a good approximation of their numerical error, we can deduce their number of significant digits and signal unstable tests:

The numerical error produced by a single operation is deduced using an Error Free Transformation for arithmetic operators and higher precision arithmetic for arbitrary mathematical functions.
Once the local numerical error has been computed, it is propagated in the rest of the computation using basic arithmetic.

It is important to note that Shaman follows the same control flow as the uninstrumented code.
This means that, while Shaman can signal that higher precision code would have taken a different branch, it will follow the original branch.
This can lead Shaman to underestimate the numerical stability of codes that have been designed to be resilient to numerical error in intermediate steps.
Hence, when Shaman indicates that a result has few/no significant digits, you should always check wether it has detected unstable branches to confirm the result.

## References

The inner workings of shaman will be detailed in an [upcoming paper]().

